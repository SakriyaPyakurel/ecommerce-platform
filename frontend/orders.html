<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <h1 class="text-3xl font-bold mb-6">My Orders</h1>

  <div class="w-1/3 text-center mb-6">
    <a href="home.html" class="bg-white text-[#5861E6] px-3 py-1 rounded font-medium">Home</a>
  </div>

  <div class="flex gap-3 mb-6">
    <button class="filter-btn bg-gray-300 px-3 py-1 rounded" data-filter="All">All</button>
    <button class="filter-btn bg-yellow-300 px-3 py-1 rounded" data-filter="Pending">Pending</button>
    <button class="filter-btn bg-green-300 px-3 py-1 rounded" data-filter="Delivered">Delivered</button>
    <button class="filter-btn bg-red-300 px-3 py-1 rounded" data-filter="Cancelled">Cancelled</button>
    <button class="filter-btn bg-purple-300 px-3 py-1 rounded" data-filter="Archived">Archived</button>
  </div>

  <div id="ordersContainer" class="w-full max-w-4xl space-y-6"></div>

  <script>
    let allOrders = [];

    async function fetchOrders() {
      try {
        const response = await fetch("http://127.0.0.1:8000/my_orders", {
          method: "GET",
          credentials: "include",
        });
        if (!response.ok) {
          console.error("fetch /my_orders returned", response.status, response.statusText);
          throw new Error("Failed to fetch orders");
        }

        const data = await response.json();

   
        allOrders = data.orders || [];
        console.log("Fetched orders:", allOrders);

        renderOrders(allOrders);
      } catch (err) {
        console.error("Error fetching orders:", err);
        document.getElementById("ordersContainer").innerHTML =
          '<p class="text-red-500">Failed to load orders. Check console for details.</p>';
      }
    }

    function attachFilters() {
      document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.onclick = () => {
          const filter = (btn.getAttribute("data-filter") || "All").toLowerCase();

          let filtered = allOrders.filter(order => {
            if (!order) return false;
            const status = String(order.status || "").toLowerCase();
            const isArchivedFlag = !!order.archived;

            if (filter === "all") return true;
            if (filter === "archived") {
              return isArchivedFlag || status === "archived";
            }
            return status === filter;
          });

          console.log("Applied filter:", filter, "->", filtered.length, "orders");
          renderOrders(filtered);

          
          document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("ring-2", "ring-offset-2", "ring-indigo-400"));
          btn.classList.add("ring-2", "ring-offset-2", "ring-indigo-400");
        };
      });
    }

    function renderOrders(orders) {
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      if (!orders || !orders.length) {
        container.innerHTML = '<p class="text-gray-500">No orders found.</p>';
        return;
      }

      orders.forEach((order) => {
        const card = renderOrderCard(order);
        container.appendChild(card);
      });
    }

    function renderOrderCard(order) {
      const card = document.createElement("div");
      card.className = "bg-white shadow-md rounded-lg p-6";

      const dateStr = order.date ? new Date(order.date).toLocaleString() : "N/A";

      const statusLower = String(order.status || "").toLowerCase();
      const statusClasses =
        statusLower === "pending" ? "bg-yellow-200 text-yellow-800" :
        statusLower === "cancelled" ? "bg-red-200 text-red-800" :
        (statusLower === "delivered" || statusLower === "completed") ? "bg-green-200 text-green-800" :
        (order.archived || statusLower === "archived") ? "bg-purple-200 text-purple-800" :
        "bg-gray-200 text-gray-800";

      card.innerHTML = `
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold">Order #${order.id}</h2>
          <span class="px-3 py-1 rounded-full text-sm ${statusClasses}">${order.status || (order.archived ? "Archived" : "Unknown")}</span>
        </div>
        <p class="text-gray-600 text-sm">Date: ${dateStr}</p>
        <p class="text-gray-600 text-sm">Delivery: ${order.delivery || "N/A"}</p>
        <p class="text-gray-600 text-sm">Total: Rs. ${order.total_amount ?? 0}</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <button class="view-items bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">View Details</button>
          ${ order.status && String(order.status).toLowerCase() === "pending" ? `<button class="cancel-order bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Cancel Order</button>` : "" }
          ${ (String(order.status || "").toLowerCase() === "delivered" || String(order.status || "").toLowerCase() === "cancelled") ? `<button class="archive-order bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">Archive</button>` : "" }
          ${ order.location ? `<a href="${order.location}" target="_blank" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">View Location</a>` : "" }
        </div>
        <div class="items-container hidden mt-4"></div>
      `;

      const viewBtn = card.querySelector(".view-items");
      const itemsContainer = card.querySelector(".items-container");
      viewBtn.onclick = () => {
        if (!itemsContainer.classList.contains("hidden")) {
          itemsContainer.classList.add("hidden");
          viewBtn.textContent = "View Details";
          return;
        }
        viewBtn.textContent = "Hide Details";
        itemsContainer.classList.remove("hidden");

        if (order.items && order.items.length) {
          renderItemsList(order.items, itemsContainer);
        } else {
          itemsContainer.innerHTML = '<div class="text-sm text-gray-500">No item details available.</div>';
        }
      };

 
      const archiveBtn = card.querySelector(".archive-order");
      if (archiveBtn) {
        archiveBtn.onclick = async () => {
          if (!confirm("Move this order to archive?")) return;
          try {
            const res = await fetch("http://127.0.0.1:8000/archive_order", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ order_id: order.id }),
            });
            const result = await res.json();
            if (result.status === "success") {
              alert("Order moved to archive");
              await fetchOrders();
            } else {
              alert("Failed to archive: " + (result.message || "Unknown error"));
            }
          } catch (err) {
            console.error("Error archiving order:", err);
            alert("Failed to archive order");
          }
        };
      }

      // Cancel handler
      const cancelBtn = card.querySelector(".cancel-order");
      if (cancelBtn) {
        cancelBtn.onclick = async () => {
          if (!confirm("Are you sure you want to cancel this order?")) return;
          try {
            const res = await fetch("http://127.0.0.1:8000/cancel_order", {
              method: "POST",
              credentials: "include",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ order_id: order.id }),
            });
            const result = await res.json();
            if (result.status === "success") {
              alert("Order cancelled successfully");
              await fetchOrders();
            } else {
              alert("Failed to cancel order: " + (result.message || "Unknown error"));
            }
          } catch (err) {
            console.error("Error cancelling order:", err);
            alert("Failed to cancel order");
          }
        };
      }

      return card;
    }

    function renderItemsList(items, container) {
      container.innerHTML = "";
      items.forEach((item) => {
        const div = document.createElement("div");
        div.className = "flex items-center gap-4 border-b py-3";

        div.innerHTML = `
          <img src="${item.media || "https://via.placeholder.com/100"}" alt="${item.name}" class="w-16 h-16 object-cover rounded" />
          <div class="flex-1">
            <h3 class="font-medium">${item.name}</h3>
            <p class="text-sm text-gray-500">${item.description || ""}</p>
            <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
          </div>
          <p class="font-semibold">Rs. ${item.price}</p>
        `;

        container.appendChild(div);
      });
    }


    document.addEventListener("DOMContentLoaded", () => {
      attachFilters();
      
      const allBtn = document.querySelector('.filter-btn[data-filter="All"]');
      if (allBtn) allBtn.classList.add("ring-2", "ring-offset-2", "ring-indigo-400");
      fetchOrders();
    });
  </script>
</body>
</html>
